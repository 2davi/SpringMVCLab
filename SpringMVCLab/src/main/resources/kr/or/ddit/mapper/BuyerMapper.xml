<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.mapper.BuyerMapper">
	
	<!-- 1:N 관계를 바인딩할 땐 중복 제거를 위한 id태그 필요 *** -->
	<resultMap type="BuyerVO" id="buyerMap" autoMapping="true">
 			<id property="buyerId" column="BUYER_ID" />
			<association property="lprod" javaType="LprodVO" autoMapping="true"/>
			<collection property="prodList" javaType="List" ofType="ProdVO">
			<id property="prodId" column="PROD_ID"/>
			<result property="buyerId" column="BUYER_ID"/>
			<result property="lprodGu" column="LPROD_GU"/>
			<result property="prodColor" column="PROD_COLOR"/>
			<result property="prodCost" column="PROD_COST"/>
			<result property="prodDelivery" column="PROD_DELIVERY"/>
			<result property="prodDetail" column="PROD_DETAIL"/>
			<result property="prodImg" column="PROD_IMG"/>
			<result property="prodInsdate" column="PROD_INSDATE"/>
			<result property="prodMileage" column="PROD_MILEAGE"/>
			<result property="prodName" column="PROD_NAME"/>
			<result property="prodOutline" column="PROD_OUTLINE"/>
			<result property="prodPrice" column="PROD_PRICE"/>
			<result property="prodProperstock" column="PROD_PROPERSTOCK"/>
			<result property="prodQtyin" column="PROD_QTYIN"/>
			<result property="prodQtysale" column="PROD_QTYSALE"/>
			<result property="prodSale" column="PROD_SALE"/>
			<result property="prodSize" column="PROD_SIZE"/>
			<result property="prodTotalstock" column="PROD_TOTALSTOCK"/>
			<result property="prodUnit" column="PROD_UNIT"/>
			</collection>
	</resultMap>
	
	<select id="selectBuyer" resultMap="buyerMap">
		WITH BUYERVIEW AS (
			SELECT
				BUYER_ID
				, BUYER_NAME
				, LPROD_GU
				, BUYER_BANK
				, BUYER_BANKNO
				, BUYER_BANKNAME
				, BUYER_ZIP
				, BUYER_ADD1
				, BUYER_ADD2
				, BUYER_COMTEL
				, BUYER_FAX
				, BUYER_MAIL
				, BUYER_CHARGER
				, BUYER_TELEXT
				, LPROD_NAME
			  FROM BUYER
			NATURAL JOIN LPROD
			 WHERE BUYER_ID = #{buyerId}
		)
		SELECT
			BUYERVIEW.*
			, PROD_ID
			, PROD_NAME
			, PROD_COST
			, PROD_PRICE
		  FROM BUYERVIEW
		 LEFT OUTER JOIN PROD ON(BUYERVIEW.BUYER_ID = PROD.BUYER_ID)
	</select>
	

	<select id="selectBuyerList" resultMap="buyerMap">
		WITH BUYERVIEW AS (
			SELECT
				BUYER_ID
				, BUYER_NAME
				, LPROD_GU
				, BUYER_BANK
				, BUYER_BANKNO
				, BUYER_BANKNAME
				, BUYER_ZIP
				, BUYER_ADD1
				, BUYER_ADD2
				, BUYER_COMTEL
				, BUYER_FAX
				, BUYER_MAIL
				, BUYER_CHARGER
				, BUYER_TELEXT
				, LPROD_NAME
			  FROM BUYER
			NATURAL JOIN LPROD
		)
		SELECT
			BUYERVIEW.*
			, PROD_ID
			, PROD_NAME
			, PROD_COST
			, PROD_PRICE
		  FROM BUYERVIEW
		 LEFT OUTER JOIN PROD ON(BUYERVIEW.BUYER_ID = PROD.BUYER_ID)
	</select>
	
	   <insert id="insertBuyer">
   <selectKey resultType="String" keyProperty="buyerId" order="BEFORE">
      SELECT  #{lprodGu}||LPAD(NVL(TO_NUMBER(SUBSTR(MAX(BUYER_ID),LENGTH(#{lprodGu})+1)),0)+1,2,'0')
      FROM BUYER
      WHERE LPROD_GU=#{lprodGu}
   </selectKey>
      INSERT INTO BUYER(
             BUYER_ID
             , BUYER_NAME
             , LPROD_GU
             , BUYER_BANK
             , BUYER_BANKNO
             , BUYER_BANKNAME
             , BUYER_ZIP
             , BUYER_ADD1
             , BUYER_ADD2
             , BUYER_COMTEL
             , BUYER_FAX
             , BUYER_MAIL
             , BUYER_CHARGER
             , BUYER_TELEXT
      )VALUES(
         #{buyerId}
         , #{buyerName}
         , #{lprodGu}
         , #{buyerBank}
         , #{buyerBankno}
         , #{buyerBankname}
         , #{buyerZip}
         , #{buyerAdd1}
         , #{buyerAdd2}
         , #{buyerComtel}
         , #{buyerFax}
         , #{buyerMail}
         , #{buyerCharger}
         , #{buyerTelext}
      )
   </insert>
   
   <update id="updateBuyer" parameterType="BuyerVO">
   	UpdATE BUYER
   	   SET BUYER_BANK    = #{buyerBank},
		   BUYER_BANKNO  = #{buyerBankno},
		   BUYER_BANKNAME= #{buyerBankname},
		   BUYER_ZIP     = #{buyerZip},
		   BUYER_ADD1    = #{buyerAdd1},
		   BUYER_ADD2    = #{buyerAdd2},
		   BUYER_COMTEL  = #{buyerComtel},
		   BUYER_FAX     = #{buyerFax},
		   BUYER_MAIL    = #{buyerMail},
		   BUYER_CHARGER = #{buyerCharger}
   	 WHERE BUYER_ID = #{buyerId}
   </update>
</mapper>